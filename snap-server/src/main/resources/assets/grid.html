<html>
  <head>
  </head>
  <body>
    <div class="section-div">
      <form id="image-form" method="post" enctype="multipart/form-data">
        <input id="image-input" type="file" name="image">
      </form>
      <div id="image-container">
        <img id="image" alt="" />
        <canvas id="lines-canvas" class="overlay-canvas" width="1024" height="1024"></canvas>
        <canvas id="grid-canvas" class="overlay-canvas" width="1024" height="1024"></canvas>
        <canvas id="crossword-canvas" class="overlay-canvas" width="1024" height="1024"></canvas>
        <canvas id="listener-canvas" class="overlay-canvas" width="1024" height="1024"></canvas>
      </div>
    </div>
    <div class="section-div">
      <div class="group">
        <span class="initial-hide show-after-session">
          <input id="operation-find-grid-lines" type="button" value="Find grid lines">
          <input id="operation-find-implicit-lines" type="button" value="Find implicit grid lines">
        </span>
        <span class="initial-hide show-after-lines">
          <input id="operation-interpolate-grid-lines" type="button" value="Interpolate grid lines">
        </span>
      </div>
      <div class="group">
        <span class="initial-hide show-after-lines">
          <input id="operation-grid-position" type="button" value="Create or reset grid">
        </span>
      </div>
      <div class="group">
        <span class="initial-hide show-after-position">
          <input id="operation-find-grid-colors" type="button" value="Parse grid colors">
          <input id="operation-find-grid-text" type="button" value="Parse grid text">
          <input id="operation-find-grid-borders" type="button" value="Parse grid borders">
          <input id="operation-export-grid" type="button" value="Export grid to Google sheet">
        </span>
        <span class="initial-hide show-after-url">
          <input id="operation-export-images" type="button" value="Export images to Google sheet">
        </span>
      </div>
      <div class="group">
        <span class="initial-hide show-after-grid">
          <input id="operation-parse-crossword" class="initial-hide show-after-grid" type="button" value="Parse crossword">
        </span>
        <span class="initial-hide show-after-crossword">
          <input id="operation-parse-crossword-clues" type="button" value="Parse crossword clues">
        </span>
        <span class="initial-hide show-after-url">
          <span class="initial-hide show-after-clues">
            <input id="operation-export-crossword" type="button" value="Export crossword to Google sheet">
          </span>
        </span>
      </div>
      <div id="loader" class="initial-hide loader"></div>
    </div>
    <div class="section-div">
      <div id="spreadsheet-url" class="group initial-hide show-after-url">
        Spreadsheet URL: <a id="spreadsheet-url-link" href="#" target="_blank"></a>
      </div>
      <div id="parameters" class="group initial-hide show-after-session">
        Approximate size of single grid square (not required, but manually tune this for better results):
        <input id="input-approx-grid-size" type="number" size="8"><br>
      </div>
      <div id="crossword-clues" class="group initial-hide show-after-crossword">
        <div>Enter crossword clues:</div>
        <textarea id="crossword-clues-textarea"></textarea>
      </div>
    </div>
  </body>

  <script src="jquery-3.3.1.min.js"></script>
  <script src="common.js"></script>
  <script>
    session = {
      sessionId: undefined,
      lines: undefined,
      pos: undefined,
      grid: undefined,
      crossword: undefined,
      clues: undefined,
      spreadsheetUrl: undefined,
      mousedownLoc: undefined,
    }

    function sessionPost(args, callback) {
      if (session.sessionId) {
        const newArgs = { path: '/session/' + session.sessionId + args.path };
        if (args.queryParams !== undefined) {
          newArgs.path += '?' + $.param(args.queryParams);
        }
        post(newArgs, callback);
      }
    }

    function rgbToStyle(rgb) {
      return 'rgb(' + ((rgb >> 16) & 0xff) + ',' + ((rgb >> 8) & 0xff) + ',' + ((rgb >> 0) & 0xff) + ')';
    }

    function closest(values, target) {
      return values.reduce(function(closest, value) {
        return Math.abs(value - target) < Math.abs(closest - target) ? value : closest;
      });
    }

    function setSessionId(sessionId) {
      session.sessionId = sessionId;
      setLines(undefined);
      $('.show-after-session').show();

      var urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('spreadsheetId')) {
        sessionPost({ path: '/parameters', queryParams: {
          spreadsheetId: urlParams.get('spreadsheetId'),
          sheetId: urlParams.get('sheetId'),
        } });
      }
    }

    function setLines(lines) {
      session.lines = lines;
      setPos(undefined);

      const canvas = $('#lines-canvas')[0];
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (lines === undefined) {
        $('.show-after-lines').hide();
        return;
      }
      $('.show-after-lines').show();

      ctx.strokeStyle = 'red';
      const image = $('#image')[0];
      const widthRatio = canvas.width / image.naturalWidth;
      const heightRatio = canvas.height / image.naturalHeight;
      for (var row of lines.horizontalLines) {
        ctx.beginPath();
        ctx.moveTo(0, row * heightRatio);
        ctx.lineTo(canvas.width, row * heightRatio);
        ctx.stroke();
      }
      for (var col of lines.verticalLines) {
        ctx.beginPath();
        ctx.moveTo(col * widthRatio, 0);
        ctx.lineTo(col * widthRatio, canvas.height);
        ctx.stroke();
      }
    }

    function setPos(pos) {
      session.pos = pos;
      setGrid(undefined);
      if (pos === undefined) {
        $('.show-after-position').hide();
        return;
      }
      $('.show-after-position').show();
    }

    function setGrid(grid) {
      session.grid = grid;
      setCrossword(undefined);

      const canvas = $('#grid-canvas')[0];
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (grid === undefined) {
        $('.show-after-grid').hide();
        return;
      }
      $('.show-after-grid').show();

      ctx.font = "18px Helvetica";
      ctx.globalAlpha = 0.5;
      const image = $('#image')[0];
      const widthRatio = canvas.width / image.naturalWidth;
      const heightRatio = canvas.height / image.naturalHeight;
      for (var i = 0; i < grid.numRows; i++) {
        for (var j = 0; j < grid.numCols; j++) {
          const row = session.pos.rows[i];
          const col = session.pos.cols[j];
          const square = grid.squares[i][j];

          ctx.beginPath();
          ctx.rect(
              widthRatio * (col.startX + col.width / 3),
              heightRatio * (row.startY + row.height / 3),
              widthRatio * (col.width / 3),
              heightRatio * (row.height / 3));
          ctx.fillStyle = rgbToStyle(square.rgb);
          ctx.fill();
          ctx.strokeStyle = 'red';
          ctx.stroke();

          ctx.strokeStyle = 'blue';
          ctx.strokeText(square.text,
              widthRatio * (col.startX + col.width / 3),
              heightRatio * (row.startY + 2 * row.height / 3));

          ctx.beginPath();
          ctx.rect(
              widthRatio * (col.startX + col.width * 2 / 3 + 1),
              heightRatio * (row.startY + row.height / 3),
              widthRatio * (square.rightBorder.width),
              heightRatio * (row.height / 3));
          ctx.fillStyle = rgbToStyle(square.rightBorder.rgb);
          ctx.fill();
          ctx.rect(
              widthRatio * (col.startX + col.width / 3),
              heightRatio * (row.startY + row.height * 2 / 3 + 1),
              widthRatio * (col.width / 3),
              heightRatio * (square.bottomBorder.width));
          ctx.fillStyle = rgbToStyle(square.bottomBorder.rgb);
          ctx.fill();
        }
      }
    }

    function setCrossword(crossword) {
      session.crossword = crossword;

      const canvas = $('#crossword-canvas')[0];
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (crossword === undefined) {
        $('.show-after-crossword').hide();
        return;
      }
      $('.show-after-crossword').show();

      ctx.font = "18px Helvetica";
      ctx.strokeStyle = 'blue';
      const image = $('#image')[0];
      const widthRatio = canvas.width / image.naturalWidth;
      const heightRatio = canvas.height / image.naturalHeight;
      for (var entry of crossword.entries) {
        const row = session.pos.rows[entry.startRow];
        const col = session.pos.cols[entry.startCol];
        ctx.strokeText(entry.clueNumber,
            widthRatio * (col.startX + col.width / 3),
            heightRatio * (row.startY + row.height * 2 / 3));
      }
    }

    function setClues(clues) {
      session.clues = clues;

      var cluesText = '';
      for (var section of clues.sections) {
        cluesText += section.direction + '\n';
        for (var clue of section.clues) {
          cluesText += clue.clue + '\n';
        }
      }
      $('#crossword-clues-textarea').val(cluesText);
      $('#crossword-clues-textarea').addClass('parsed');
    }

    function setSpreadsheetUrl(spreadsheetUrl) {
      session.spreadsheetUrl = spreadsheetUrl;

      $('.show-after-url').show();
      $('#spreadsheet-url-link').attr('href', spreadsheetUrl);
      $('#spreadsheet-url-link').text(spreadsheetUrl);
    }

    $(document).ready(function() {
      $('#image-input').change(e => {
        const image = e.target.files[0];
        const formData = new FormData();
        formData.append('image', image);
        post({ path: '/session', body: formData }, sessionId => {
          setSessionId(sessionId);
          $('#image').attr('src', URL.createObjectURL(image));
        });
      });

      $('#listener-canvas').mousedown(e => session.mousedownLoc = { x: e.offsetX, y: e.offsetY });
      $('#listener-canvas').mouseup(e => {
        const startLoc = session.mousedownLoc;
        if (session.lines && startLoc) {
          const dx = Math.abs(startLoc.x - e.offsetX);
          const dy = Math.abs(startLoc.y - e.offsetY);
          const horizontalLines = session.lines.horizontalLines;
          const verticalLines = session.lines.verticalLines;
          const image = $('#image')[0];
          const canvas = $('#listener-canvas')[0];
          const widthRatio = canvas.scrollWidth / image.naturalWidth;
          const heightRatio = canvas.scrollHeight / image.naturalHeight;
          const imageX = Math.floor(startLoc.x / widthRatio);
          const imageY = Math.floor(startLoc.y / heightRatio);
          if (dx >= 2 && dx >= dy) {
            horizontalLines.push(imageY);
          } else if (dy >= 2 && dy > dx) {
            verticalLines.push(imageX);
          } else {
            const closestHorizontal = horizontalLines ? closest(horizontalLines, imageY) : NaN;
            const closestVertical = verticalLines ? closest(verticalLines, imageX) : NaN;
            const closestHorizontalDist = Math.abs(closestHorizontal - imageY);
            const closestVerticalDist = Math.abs(closestVertical - imageX);
            if (closestHorizontalDist < 10) {
              horizontalLines.splice(horizontalLines.indexOf(closestHorizontal), 1);
            } else if (closestVerticalDist < 10) {
              verticalLines.splice(verticalLines.indexOf(closestVertical), 1);
            } else if (closestHorizontalDist > closestVerticalDist) {
              horizontalLines.push(imageY);
            } else {
              verticalLines.push(imageX);
            }
          }
          sessionPost({ path: '/lines/manual', queryParams: {
            horizontalLines: horizontalLines.join(','),
            verticalLines: verticalLines.join(',')
          } }, drawLines);
        }
      });

      $('#input-approx-grid-size').on('blur', e => {
        sessionPost({ path: '/parameters', queryParams: { approxGridSize: e.target.value } });
      });

      $('#crossword-clues-textarea').on('input', e => {
        $('.show-after-clues').show();
        $('#crossword-clues-textarea').removeClass('parsed');
      });

      $('#operation-find-grid-lines').click(e => sessionPost({ path: '/lines' }, setLines));
      $('#operation-find-implicit-lines').click(e => sessionPost({ path: '/lines/implicit' }, setLines));
      $('#operation-interpolate-grid-lines').click(e => sessionPost({ path: '/lines/interpolate' }, setLines));

      $('#operation-grid-position').click(e => sessionPost({ path: '/position' }, setPos));

      $('#operation-find-grid-colors').click(e => sessionPost({ path: '/grid/colors' }, setGrid));
      $('#operation-find-grid-text').click(e => sessionPost({ path: '/grid/text' }, setGrid));
      $('#operation-find-grid-borders').click(e => sessionPost({ path: '/grid/borders' }, setGrid));
      $('#operation-export-grid').click(e => sessionPost({ path: '/spreadsheet/grid' }, setSpreadsheetUrl));
      $('#operation-export-images').click(e => sessionPost({ path: '/spreadsheet/images' }, setSpreadsheetUrl));

      $('#operation-parse-crossword').click(e => sessionPost({ path: '/crossword' }, setCrossword));
      $('#operation-parse-crossword-clues').click(e => {
        const unparsedClues = $('#crossword-clues-textarea').val();
        sessionPost({ path: '/crossword/clues', queryParams: { clues: unparsedClues } }, setClues);
      });
      $('#operation-export-crossword').click(e => sessionPost({ path: '/spreadsheet/crossword' }, setSpreadsheetUrl));
    });
  </script>

  <link rel="stylesheet" href="style.css">
  <style>
    .section-div {
      float: left;
      margin: 20px;
      width: calc(33% - 60px);
    }

    [type=button] {
      display: block;
    }

    .group {
      margin-bottom: 10px;
    }

    #crossword-clues-textarea {
      width: 80%;
      height: 80%;
    }
  </style>
</html>
