<html>
  <head>
  </head>
  <body>
    <div id="image-div">
      <form id="image-form" method="post" enctype="multipart/form-data">
        <input id="image-input" type="file" name="image">
      </form>
      <img id="image" alt="" />
    </div>
    <div id="operations-div">
      <input id="operation-find-grid-lines" type="button" value="Find grid lines">
      <input id="operation-interpolate-grid-lines" type="button" value="Interpolate grid lines">
      <input id="operation-find-implicit-lines" type="button" value="Find implicit grid lines">
      <input id="operation-find-grid-colors" type="button" value="Parse grid colors">
      <input id="operation-find-grid-text" type="button" value="Parse grid text">
      <input id="operation-find-grid-borders" type="button" value="Parse grid borders">
      <input id="operation-export-to-spreadsheet" type="button" value="Export to Google sheet">
    </div>
    <div id="misc-div">
      <div id="spreadsheet-url">
        <span>Spreadsheet URL:</span>
        <a id="spreadsheet-url-link" href="#" target="_blank"></span>
      </div>
    </div>
  </body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    sessionId = undefined;
    lines = undefined;
    grid = undefined;
    spreadsheetUrl = undefined;

    function maybePost(sessionPath, callback) {
      if (sessionId) {
        fetch('/api/session/' + sessionId + sessionPath, { method: 'POST' })
          .then(response => { return response.json(); })
          .then(callback);
      }
    }

    function drawLines(lines) {
      console.log(lines);
    }

    function drawGrid(grid) {
      console.log(grid);
    }

    $(document).ready(function() {
      $('#image-input').change(e => {
	    const image = e.target.files[0];
        const formData = new FormData();
        formData.append('image', image);
        fetch('/api/session', { method: 'POST', body: formData }).then(response => {
          return response.text();
        }).then(data => {
          sessionId = data;
          $('#image').attr('src', URL.createObjectURL(image));
        });
      });

      $('#operation-find-grid-lines').click(e => maybePost('/lines', drawLines));
      $('#operation-interpolate-grid-lines').click(e => maybePost('/lines/interpolate', drawLines));
      $('#operation-find-implicit-grid-lines').click(e => maybePost('/lines/implicit', drawLines));
      $('#operation-find-grid-colors').click(e => maybePost('/grid/colors', drawGrid));
      $('#operation-find-grid-text').click(e => maybePost('/grid/text', drawGrid));
      $('#operation-find-grid-borders').click(e => maybePost('/grid/borders', drawGrid));

      $('#operation-export-to-spreadsheet').click(e => {
        if (sessionId) {
          fetch('/api/session/' + sessionId + '/spreadsheet', { method: 'POST' }).then(response => {
            return response.text();
          }).then(data => {
            spreadsheetUrl = data;
            $('#spreadsheet-url-link').attr('href', spreadsheetUrl).text(spreadsheetUrl);
          });
        }
      });
    });
  </script>
  <style>
    div {
      float: left;
      margin: 20px;
      width: calc(33% - 60px);
    }

    #image {
      max-height: 100%;
      max-width: 100%;
    }

    [type=button] {
      display: block;
    }
  </style>
</html>
