<html>
  <head>
  </head>
  <body>
    <div class="half">
      <div id="edit-mode">
        <div>Enter wordsearch grid:</div>
        <textarea id="wordsearch-textarea"></textarea>
        <br>
        <input id="solve-wordsearch" type="button" value="Solve Wordsearch"><br>
        <div id="loader" class="initial-hide loader"></div>
      </div>
      <div id="view-mode" class="initial-hide">
        <input id="back-to-edit-mode" class="linker" type="button" value="&lt; Edit grid">
        <br>
        <table id="results-grid">
        </table>
      </div>
    </div>
    <div class="half">
      <input name="direction-mode" type="radio" value="straight" checked>Straight
      <input name="direction-mode" type="radio" value="boggle">Boggle
      <br>
      <div id="results-list">
      </div>
    </div>
  </body>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="common.js"></script>
  <script>
    session = {
      results: [],
    };

    function getGrid() {
      return $('#wordsearch-textarea').val().trim().toUpperCase().split('\n')
          .map(word => word.replace(/\s/g, ''));
    }

    function setResults() {
      const grid = getGrid();

      $('#results-grid').empty();
      const table = [];
      for (var i = 0; i < grid.length; i++) {
        const row = [];
        const rowHtml = document.createElement('tr');
        for (var j = 0; j < grid[i].length; j++) {
          const colHtml = document.createElement('td');
          colHtml.innerText = grid[i][j];
          row.push(colHtml);
          rowHtml.append(colHtml);
        }
        table.push(row);
        $('#results-grid').append(rowHtml);
      }

      $('#results-list').empty();
      var results = session.results;
      if ($('input:radio[name="direction-mode"]:checked').val() === 'straight') {
        results = results.filter(result => {
          const steps = new Set();
          for (var i = 0; i < result.positions.length - 1; i++) {
            steps.add({
              x: result.positions[i + 1].x - result.positions[i].x,
              y: result.positions[i + 1].y - result.positions[i].y,
            });
          }
          return steps.size === 1;
        });
      }
      results.sort(function(result1, result2) {
        return result2.word.length - result1.word.length;
      });
      for (const result of results) {
        const resultHtml = document.createElement('input');
        resultHtml.value = result.word;
        resultHtml.readOnly = true;
        resultHtml.className = 'linker';
        resultHtml.onmouseenter = function() {
          for (const position of result.positions) {
            table[position.y][position.x].style.background = '#cccccc';
          }
        }
        resultHtml.onmouseleave = function() {
          for (const position of result.positions) {
            table[position.y][position.x].style.background = '';
          }
        }
        $('#results-list').append(resultHtml);
      }
    }

    $(document).ready(function() {
      $('#back-to-edit-mode').click(e => {
        $('#edit-mode').show();
        $('#view-mode').hide();
      });

      $('#solve-wordsearch').click(e => {
        $('.loader').show();
        postJson({ path: '/words/search', body: { grid: getGrid() } }, response => {
          session.results = response.results;
          setResults();
          $('#edit-mode').hide();
          $('#view-mode').show();
          $('.loader').hide();
        });
      });

      $('input[type=radio][name="direction-mode"]').change(() => {
        setResults();
      });
    });
  </script>

  <link rel="stylesheet" href="style.css">
  <style>
    #wordsearch-textarea {
      width: 80%;
      height: 80%;
    }

    #results-grid {
      border: 1px black solid;
      margin: 10px;
    }

    #results-list {
      max-height: 90%;
      overflow: auto;
    }
  </style>
</html>