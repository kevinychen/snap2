<html>
  <head>
  </head>
  <body>
    <div class="half">
      <form id="pdf-form" method="post" enctype="multipart/form-data">
        <input id="pdf-input" type="file" name="pdf">
      </form>
      <div id="image-container">
        <img id="image" alt="" />
      </div>
    </div>
    <div class="half">
      <div id="options">
      </div>
      <div id="sheet">
        Sheet URL: <input id="sheet-url" size=80">
        <input id="sheet-new" type="button" value="Create new sheet">
        <br>
        <iframe id="sheet-frame" src=""></iframe>
      </div>
    </div>
  </body>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    session = {
      document: undefined,
      page: 0,
      spreadsheetId: undefined,
      sheetId: undefined,
    };

    function getImageAsDataURL(id, callback) {
      fetch(`/api/files/${id}`, { method: 'GET' })
        .then(response => {
          return response.blob();
        })
        .then(blob => {
          const reader = new FileReader()
          reader.onloadend = () => {
            callback(reader.result);
          };
          reader.readAsDataURL(blob);
        });
    }

    function showSheet() {
      if (session.spreadsheetId === undefined) {
        $('#sheet-url').val('Invalid Google Sheet URL');
        return;
      }
      const url = `https://docs.google.com/spreadsheets/d/${session.spreadsheetId}/preview#gid=${session.sheetId}`
      $('#sheet-url').val(url);
      $('#sheet-frame').attr('src', url);
    }

    function post(args, callback) {
      fetch('/api' + args.path, { method: 'POST', body: args.body })
        .then(response => {
          if (!response.ok) {
            alert('Error: ' + response.statusText);
            return;
          }
          return response.json();
        })
        .then(callback);
    }

    $(document).ready(function() {
      $('#pdf-input').change(e => {
        const pdf = e.target.files[0];
        const formData = new FormData();
        formData.append('pdf', pdf);
        post({ path: '/documents/pdf', body: formData }, document => {
          session.document = document;
          if (session.page >= document.pages.length) {
            session.page = 0;
          }
          const page = document.pages[session.page];
          getImageAsDataURL(page.imageId, dataURL => {
            $('#image').attr('src', dataURL);
          });
        });
      });

      $('#sheet-url').on('input', e => {
        const url = e.target.value;
        const match = url.match(new RegExp('https://docs\.google\.com/spreadsheets/d/([A-Za-z0-9_-]+)/.*(?:gid=([0-9]+))'));
        if (match) {
          session.spreadsheetId = match[1];
          session.sheetId = match[2];
        } else {
          session.spreadsheetId = undefined;
          session.sheetId = undefined;
        }
        showSheet();
      });
    });
  </script>

  <style>
    #image-container {
      position: relative;
    }

    #image {
      max-height: 100%;
      max-width: 100%;
      border: 1px black solid;
    }

    #options {
      height: 25%;
    }

    #sheet-frame {
      height: 175%;
      width: 250%;
      -webkit-transform: scale(0.4);
      -webkit-transform-origin: 0 0;
    }

    .half {
      height: 100%;
      width: 48%;
      float: left;
      margin: 1%;
    }
  </style>
</html>
