<html>
  <head>
  </head>
  <body>
    <div class="half">
      Upload PDF: <input id="pdf-input" type="file" name="pdf">
      <br>
      or paste URL: <input id="pdf-url-input" size=80>
      <br>
      <div class="initial-hide after-document">
        <input id="document-page-left" class="nav" type="button" value="&lt;">
        Page <span id="document-page-current"></span>/<span id="document-page-total"></span>
        <input id="document-page-right" class="nav" type="button" value="&gt;">
        <br>
        <div id="image-container">
          <img id="image" alt="" />
          <canvas id="section-canvas" class="overlay-canvas" width="0" height="0"></canvas>
          <canvas id="listener-canvas" class="overlay-canvas" width="0" height="0"></canvas>
        </div>
      </div>
    </div>
    <div class="half">
      <div id="options">
        <input id="export-section" class="initial-hide after-section" type="button" value="Copy to Google Sheet"><br>
        <br>
        <input id="operation-find-grid-lines" class="initial-hide after-section" type="button" value="Parse grid lines">
        <br>
        <span class="initial-hide after-grid-lines">
          <input id="operation-find-grid" type="button" value="Parse grid">
          <input id="operation-find-grid-colors" type="checkbox" checked>colors
          <input id="operation-find-grid-borders" type="checkbox">borders
        </span>
        <br>
        <br>
        <div id="loader" class="initial-hide loader"></div>
      </div>
      <div id="sheet">
        Sheet URL: <input id="sheet-url" size=80>
        <input id="sheet-new" class="initial-hide" type="button" value="Create new sheet"><br>
        <iframe id="sheet-frame" src=""></iframe>
      </div>
    </div>
  </body>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    session = {
      document: undefined,
      page: 0,
      rectangle: undefined,
      gridLines: undefined,
      gridPosition: undefined,
      grid: undefined,
      spreadsheetId: undefined,
      sheetId: undefined,
    };

    function getImageAsDataURL(id, callback) {
      fetch(`/api/files/${id}`, { method: 'GET' })
        .then(response => {
          return response.blob();
        })
        .then(blob => {
          const reader = new FileReader()
          reader.onloadend = () => {
            callback(reader.result);
          };
          reader.readAsDataURL(blob);
        });
    }

    function post(args, callback) {
      fetch('/api' + args.path, { method: 'POST', body: args.body, headers: args.headers })
        .then(response => {
          if (!response.ok) {
            alert('Error: ' + response.statusText);
            return;
          }
          return response.json().then(callback);
        })
    }

    function rgbToStyle(rgb) {
      return 'rgb(' + ((rgb >> 16) & 0xff) + ',' + ((rgb >> 8) & 0xff) + ',' + ((rgb >> 0) & 0xff) + ')';
    }

    function postJson(args, callback) {
      post({
        path: args.path,
        body: JSON.stringify(args.body),
        headers: { 'Content-type': 'application/json' },
      }, callback);
    }

    function setDocument(document) {
      session.document = document;
      setPage(0);
      $('.after-document').show();
    }

    function setPage(page) {
      session.page = page;
      const pages = session.document.pages;
      if (page >= 0 && page < pages.length) {
        $('#document-page-left').prop('disabled', page == 0);
        $('#document-page-current').text(page + 1);
        $('#document-page-total').text(pages.length);
        $('#document-page-right').prop('disabled', page == pages.length - 1);
        getImageAsDataURL(pages[page].imageId, dataURL => {
          $('#image')
            .attr('src', dataURL)
            .on('load', e => {
              const image = $('#image')[0];
              $('.overlay-canvas').get().forEach(canvas => {
                canvas.width = image.naturalWidth;
                canvas.height = image.naturalHeight;
              });
            });
        });
      }
    }

    function setRectangle(rectangle) {
      session.rectangle = rectangle;
      setGridLines(undefined);
      if (rectangle) {
        $('.after-section').show();
      } else {
        $('.after-section').hide();
      }
    }

    function setGridLines(gridLines, gridPosition) {
      session.gridLines = gridLines;
      session.gridPosition = gridPosition;
      setGrid(undefined);
      if (gridLines) {
        $('.after-grid-lines').show();
      } else {
        $('.after-grid-lines').hide();
      }
    }

    function setGrid(grid) {
      session.grid = grid;
      if (session.rectangle) {
        drawSectionCanvas();
      }
    }

    function setSheet(spreadsheetId, sheetId) {
      if (spreadsheetId === undefined) {
        $('#sheet-url').val('Invalid Google Sheet URL');
        return;
      }
      const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}#gid=${sheetId}`
      $('#sheet-url').val(url);
      $('#sheet-frame').attr('src', url);
      session.spreadsheetId = spreadsheetId;
      session.sheetId = sheetId;
      post({ path: `/documents/sheets/${spreadsheetId}/${sheetId}` });
    }

    function drawSectionCanvas() {
      const image = $('#image')[0];
      const canvas = $('#section-canvas')[0];
      const ctx = canvas.getContext('2d');
      const widthRatio = canvas.width / image.naturalWidth;
      const heightRatio = canvas.height / image.naturalHeight;
      const offsetX = session.rectangle.x;
      const offsetY = session.rectangle.y;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (session.gridLines) {
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        for (var row of session.gridLines.horizontalLines) {
          ctx.beginPath();
          ctx.moveTo(offsetX, offsetY + row * heightRatio);
          ctx.lineTo(offsetX + session.rectangle.width, offsetY + row * heightRatio);
          ctx.stroke();
        }
        for (var col of session.gridLines.verticalLines) {
          ctx.beginPath();
          ctx.moveTo(offsetX + col * widthRatio, offsetY);
          ctx.lineTo(offsetX + col * widthRatio, offsetY + session.rectangle.height);
          ctx.stroke();
        }
      }
      if (session.grid) {
        for (var i = 0; i < session.grid.numRows; i++) {
          for (var j = 0; j < session.grid.numCols; j++) {
            const row = session.gridPosition.rows[i];
            const col = session.gridPosition.cols[j];
            const square = session.grid.squares[i][j];

            ctx.rect(
              offsetX + widthRatio * (col.startX + col.width / 3),
              offsetY + heightRatio * (row.startY + row.height / 3),
              widthRatio * (col.width / 3),
              heightRatio * (row.height / 3));
            ctx.fillStyle = rgbToStyle(square.rgb);
            ctx.fill();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.rect(
              offsetX + widthRatio * (col.startX + col.width * 2 / 3 + 1),
              offsetY + heightRatio * (row.startY + row.height / 3),
              widthRatio * (square.rightBorder.width),
              heightRatio * (row.height / 3));
            ctx.fillStyle = rgbToStyle(square.rightBorder.rgb);
            ctx.fill();
            ctx.beginPath();
            ctx.rect(
              offsetX + widthRatio * (col.startX + col.width / 3),
              offsetY + heightRatio * (row.startY + row.height * 2 / 3 + 1),
              widthRatio * (col.width / 3),
              heightRatio * (square.bottomBorder.width));
            ctx.fillStyle = rgbToStyle(square.bottomBorder.rgb);
            ctx.fill();
          }
        }
      }
    }

    $(document).ready(function() {
      $('#pdf-input').change(e => {
        const pdf = e.target.files[0];
        if (pdf) {
          const formData = new FormData();
          formData.append('pdf', pdf);
          post({ path: '/documents/pdf', body: formData }, setDocument);
        }
      });

      $('#pdf-url-input').on('input', e => {
        const url = e.target.value;
        postJson({ path: '/documents/url', body: { url: url } }, setDocument);
      });

      $('#document-page-left').on('click', e => {
        setPage(session.page - 1);
      });
      $('#document-page-right').on('click', e => {
        setPage(session.page + 1);
      });

      (function() {
        const canvas = $('#listener-canvas')[0];
        const ctx = canvas.getContext('2d');
        var mousedownLoc = undefined;
        var isMouseDown = false;
        $('#listener-canvas')
          .mousedown(e => {
            const x = canvas.width / canvas.scrollWidth * e.offsetX;
            const y = canvas.height / canvas.scrollHeight * e.offsetY;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            mousedownLoc = { x: x, y: y };
            isMouseDown = true;
            setRectangle(undefined);
          })
          .mousemove(e => {
            if (isMouseDown) {
              const x = canvas.width / canvas.scrollWidth * e.offsetX;
              const y = canvas.height / canvas.scrollHeight * e.offsetY;
              const rectangle = {
                x: Math.min(x, mousedownLoc.x),
                y: Math.min(y, mousedownLoc.y),
                width: Math.abs(mousedownLoc.x - x),
                height: Math.abs(mousedownLoc.y - y),
              };
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.clearRect(rectangle.x, rectangle.y, rectangle.width, rectangle.height);
              ctx.strokeStyle = 'red';
              ctx.lineWidth = 4;
              ctx.strokeRect(rectangle.x, rectangle.y, rectangle.width, rectangle.height);
              setRectangle(rectangle);
            }
          })
          .mouseup(e => {
            isMouseDown = false;
          });
      })();

      $('#export-section').on('click', e => {
        $('#loader').show();
        postJson({ path: `/documents/${session.document.id}/export/${session.spreadsheetId}/${session.sheetId}`, body: {
          page: session.page,
          rectangle: session.rectangle,
        } }, marker => {
          $('#loader').hide();
        });
      });

      $('#operation-find-grid-lines').on('click', e => {
        $('#loader').show();
        postJson({ path: `/documents/${session.document.id}/lines`, body: {
          page: session.page,
          rectangle: session.rectangle,
        } }, response => {
          setGridLines(response.gridLines, response.gridPosition);
          $('#loader').hide();
        });
      });

      $('#operation-find-grid').on('click', e => {
        $('#loader').show();
        postJson({ path: `/documents/${session.document.id}/grid`, body: {
          section: {
            page: session.page,
            rectangle: session.rectangle,
          },
          gridPosition: session.gridPosition,
          findColors: $('#operation-find-grid-colors').is(':checked'),
          findBorders: $('#operation-find-grid-borders').is(':checked'),
        } }, grid => {
          setGrid(grid);
          $('#loader').hide();
        });
      });

      $('#sheet-url').on('input', e => {
        const url = e.target.value;
        const match = url.match(new RegExp('https://docs\.google\.com/spreadsheets/d/([A-Za-z0-9_-]+).*(?:gid=([0-9]+))'));
        if (match) {
          setSheet(match[1], match[2]);
        } else {
          setSheet(undefined);
        }
      });

      setSheet('1k9O-5t-gIpcvwWna4NVfD2BqjjeBQLAED35tLm_L_Vk', 1538405940);
    });
  </script>

  <style>
    #image-container {
      position: relative;
    }

    #image {
      max-height: 100%;
      max-width: 100%;
      border: 1px black solid;
    }

    #options {
      height: 25%;
    }

    #sheet-frame {
      height: 175%;
      width: 250%;
      -webkit-transform: scale(0.4);
      -webkit-transform-origin: 0 0;
    }

    .half {
      height: 100%;
      width: 48%;
      float: left;
      margin: 1%;
    }

    .initial-hide {
      display: none;
    }

    .nav {
      color: #000;
      background-color: #f1f1f1;
      font-size: 18px;
      border-radius: 50%;
    }

    .nav:hover:enabled {
      background-color: #cccccc;
    }

    .overlay-canvas {
      position: absolute;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100%;
    }

    .loader {
      border: 3px solid #f3f3f3;
      animation: spin 1s linear infinite;
      border-top: 3px solid #555;
      border-radius: 50%;
      width: 30px;
      height: 30px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</html>
